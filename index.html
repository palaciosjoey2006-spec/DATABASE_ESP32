<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCADA - TUVN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 'tech': ['Orbitron', 'sans-serif'], 'body': ['Roboto', 'sans-serif'] },
                    colors: { metal: { 900: '#0f172a', 800: '#1e293b' }, neon: { blue: '#06b6d4', green: '#10b981', purple: '#a855f7', red: '#ef4444' } }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #0b1120; color: #e2e8f0; background-image: url('https://www.transparenttextures.com/patterns/carbon-fibre.png'); }
        .glass-panel { background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(6, 182, 212, 0.3); backdrop-filter: blur(5px); }
        .tech-font { font-family: 'Orbitron', sans-serif; }
        .led-btn-on { background: rgba(16,185,129,0.2); border-color: #10b981; color: #10b981; box-shadow: 0 0 10px #10b981; }
        .led-btn-off { background: rgba(30,41,59,0.5); border-color: #334155; color: #64748b; }
        .disabled-control { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
    </style>
</head>
<body class="min-h-screen flex flex-col overflow-hidden">

    <div id="authModal" class="fixed inset-0 z-50 bg-black/95 flex items-center justify-center backdrop-blur-md">
        <div class="glass-panel p-8 rounded-2xl w-full max-w-md text-center border-t-4 border-neon-blue">
            <h2 class="text-2xl font-bold tech-font text-white mb-6">ACCESO AL SISTEMA</h2>
            <div id="roleSelection" class="grid grid-cols-2 gap-4">
                <button onclick="selectRole('operator')" class="p-4 bg-metal-800 border border-slate-600 rounded-xl hover:border-neon-blue transition">
                    <i data-lucide="eye" class="w-8 h-8 mx-auto mb-2 text-slate-400"></i>
                    <div class="font-bold">OPERARIO</div>
                </button>
                <button onclick="showAdminLogin()" class="p-4 bg-metal-800 border border-slate-600 rounded-xl hover:border-neon-red transition">
                    <i data-lucide="shield-alert" class="w-8 h-8 mx-auto mb-2 text-slate-400"></i>
                    <div class="font-bold">ADMIN</div>
                </button>
            </div>
            <div id="adminLogin" class="hidden mt-4">
                <input type="password" id="adminPass" class="w-full bg-metal-900 border border-slate-600 rounded p-2 text-center text-white mb-2" placeholder="CLAVE">
                <div class="flex gap-2">
                    <button onclick="cancelAdmin()" class="flex-1 py-2 bg-slate-700 rounded">VOLVER</button>
                    <button onclick="verifyAdmin()" class="flex-1 py-2 bg-neon-red text-black font-bold rounded">ENTRAR</button>
                </div>
            </div>
        </div>
    </div>

    <div id="configModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 hidden">
        <div class="bg-slate-900 border border-slate-700 p-6 rounded-2xl w-11/12 max-w-md">
            <h3 class="text-xl font-bold text-white mb-4">Configurar Firebase</h3>
            <input type="text" id="apiKeyInput" placeholder="API KEY" class="w-full bg-slate-800 border border-slate-600 rounded p-2 mb-2 text-white text-xs">
            <input type="text" id="dbUrlInput" placeholder="DATABASE URL" class="w-full bg-slate-800 border border-slate-600 rounded p-2 mb-4 text-white text-xs">
            <button onclick="saveConfig()" class="w-full bg-blue-600 text-white font-bold py-2 rounded">GUARDAR Y CONECTAR</button>
            <button onclick="document.getElementById('configModal').classList.add('hidden')" class="w-full mt-2 text-slate-400 text-xs">CERRAR</button>
        </div>
    </div>

    <header class="bg-metal-900 border-b border-neon-blue p-4 flex justify-between items-center z-40 sticky top-0">
        <div class="flex items-center gap-3">
            <i data-lucide="cpu" class="text-neon-blue w-6 h-6"></i>
            <div>
                <h1 class="font-bold text-white tech-font text-lg leading-none">TUVN SCADA</h1>
                <span id="userRoleBadge" class="text-[10px] bg-slate-700 px-2 rounded text-slate-300">NO IDENTIFICADO</span>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <div class="text-right hidden md:block">
                <div id="timeDisplay" class="text-neon-green font-mono font-bold">--:--:--</div>
            </div>
            <button onclick="document.getElementById('configModal').classList.remove('hidden')" class="p-2 bg-metal-800 rounded border border-slate-600"><i data-lucide="settings" class="w-4 h-4 text-slate-400"></i></button>
            <button onclick="logout()" class="p-2 bg-metal-800 rounded border border-slate-600"><i data-lucide="log-out" class="w-4 h-4 text-red-400"></i></button>
        </div>
    </header>

    <main class="flex-grow p-4 overflow-y-auto container mx-auto">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="glass-panel p-4 rounded-xl flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-metal-900 rounded-full border border-slate-700"><i data-lucide="lightbulb" id="icon_led1" class="text-slate-500 w-6 h-6"></i></div>
                    <div>
                        <h3 class="text-white font-bold text-sm">SALA</h3>
                        <p id="mode_txt_led1" class="text-[10px] text-slate-400 font-mono">AUTO</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="btn_on_1" onclick="controlLed('sala', true)" class="px-4 py-1 rounded border border-slate-600 text-xs font-bold text-slate-300 hover:bg-neon-green/20 hover:text-neon-green disabled-control transition">ON</button>
                    <button id="btn_off_1" onclick="controlLed('sala', false)" class="px-4 py-1 rounded border border-slate-600 text-xs font-bold text-slate-300 hover:bg-slate-700 disabled-control transition">AUTO/OFF</button>
                </div>
            </div>

            <div class="glass-panel p-4 rounded-xl flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-metal-900 rounded-full border border-slate-700"><i data-lucide="zap" id="icon_led2" class="text-slate-500 w-6 h-6"></i></div>
                    <div>
                        <h3 class="text-white font-bold text-sm">LABORATORIO</h3>
                        <p id="mode_txt_led2" class="text-[10px] text-slate-400 font-mono">AUTO</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="btn_on_2" onclick="controlLed('laboratorio', true)" class="px-4 py-1 rounded border border-slate-600 text-xs font-bold text-slate-300 hover:bg-neon-blue/20 hover:text-neon-blue disabled-control transition">ON</button>
                    <button id="btn_off_2" onclick="controlLed('laboratorio', false)" class="px-4 py-1 rounded border border-slate-600 text-xs font-bold text-slate-300 hover:bg-slate-700 disabled-control transition">AUTO/OFF</button>
                </div>
            </div>
        </div>

        <div class="glass-panel p-4 rounded-xl mb-6 border-l-4 border-neon-purple flex items-center justify-between">
            <div>
                <h3 class="text-neon-purple font-bold text-sm">PROMEDIO GENERAL</h3>
                <div class="text-4xl font-bold text-white tech-font mt-1" id="val_avg">--</div>
            </div>
            <div class="h-16 w-32">
                <canvas id="chart_avg"></canvas>
            </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="glass-panel p-3 rounded-xl text-center">
                <h4 class="text-xs text-neon-blue font-bold mb-1">ANGAR 1</h4>
                <div class="text-2xl font-bold text-white tech-font" id="val1">--</div>
            </div>
            <div class="glass-panel p-3 rounded-xl text-center">
                <h4 class="text-xs text-neon-green font-bold mb-1">ANGAR 2</h4>
                <div class="text-2xl font-bold text-white tech-font" id="val2">--</div>
            </div>
            <div class="glass-panel p-3 rounded-xl text-center">
                <h4 class="text-xs text-neon-blue font-bold mb-1">ANGAR 3</h4>
                <div class="text-2xl font-bold text-white tech-font" id="val3">--</div>
            </div>
            <div class="glass-panel p-3 rounded-xl text-center">
                <h4 class="text-xs text-neon-green font-bold mb-1">ANGAR 4</h4>
                <div class="text-2xl font-bold text-white tech-font" id="val4">--</div>
            </div>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        lucide.createIcons();
        let db, currentUserRole = null;
        let charts = [];

        // --- CHART JS ---
        const initChart = (id, color) => {
            const ctx = document.getElementById(id).getContext('2d');
            return new Chart(ctx, {
                type: 'line',
                data: { labels: Array(20).fill(''), datasets: [{ data: Array(20).fill(0), borderColor: color, borderWidth: 2, pointRadius: 0, fill: false }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } }, animation: { duration: 0 } }
            });
        };
        const chartAvg = initChart('chart_avg', '#a855f7');

        // --- RELOJ ---
        setInterval(() => {
            document.getElementById('timeDisplay').innerText = new Date().toLocaleTimeString();
        }, 1000);

        // --- FUNCIONES GLOBALES ---
        window.showAdminLogin = () => { document.getElementById('roleSelection').classList.add('hidden'); document.getElementById('adminLogin').classList.remove('hidden'); };
        window.cancelAdmin = () => { document.getElementById('adminLogin').classList.add('hidden'); document.getElementById('roleSelection').classList.remove('hidden'); };
        window.selectRole = (r) => applyRole(r);
        window.verifyAdmin = () => { if(document.getElementById('adminPass').value === '1234') applyRole('admin'); else Swal.fire('Error', 'Clave incorrecta', 'error'); };
        window.logout = () => { applyRole(null); document.getElementById('authModal').classList.remove('hidden'); document.getElementById('roleSelection').classList.remove('hidden'); document.getElementById('adminLogin').classList.add('hidden'); };

        window.saveConfig = () => {
            const k = document.getElementById('apiKeyInput').value;
            const u = document.getElementById('dbUrlInput').value;
            localStorage.setItem('iot_api_key', k);
            localStorage.setItem('iot_db_url', u);
            initFirebase(k, u);
            document.getElementById('configModal').classList.add('hidden');
        };

        function applyRole(role) {
            currentUserRole = role;
            document.getElementById('authModal').classList.add('hidden');
            const badge = document.getElementById('userRoleBadge');
            const btns = document.querySelectorAll('button[id^="btn_"]');

            if(role === 'admin') {
                badge.innerText = 'ADMINISTRADOR'; badge.className = 'text-[10px] bg-neon-red text-black px-2 rounded font-bold';
                btns.forEach(b => b.classList.remove('disabled-control'));
            } else if(role === 'operator') {
                badge.innerText = 'OPERARIO'; badge.className = 'text-[10px] bg-slate-600 text-white px-2 rounded font-bold';
                btns.forEach(b => b.classList.add('disabled-control'));
            } else {
                badge.innerText = 'NO IDENTIFICADO';
                btns.forEach(b => b.classList.add('disabled-control'));
            }
        }

        // --- CONTROL ---
        window.controlLed = (foco, estado) => {
            if(currentUserRole !== 'admin') return;
            if(!db) return Swal.fire('Error', 'Sin conexión', 'error');
            set(ref(db, 'control/' + foco), estado);
        };

        function initFirebase(apiKey, databaseURL) {
            const app = initializeApp({ apiKey, databaseURL });
            db = getDatabase(app);
            
            onValue(ref(db, 'monitor'), (snap) => {
                const data = snap.val();
                if(!data) return;

                // Temps
                if(data.temperaturas) {
                    ['val1','val2','val3','val4'].forEach((id, i) => document.getElementById(id).innerText = parseFloat(data.temperaturas['t'+(i+1)]).toFixed(1));
                    document.getElementById('val_avg').innerText = parseFloat(data.temperaturas.promedio).toFixed(1);
                    
                    const d = chartAvg.data.datasets[0].data; d.push(data.temperaturas.promedio); d.shift(); chartAvg.update();
                }

                // Estados
                if(data.estado) {
                    updateLedUI('1', data.estado.sala === "ON", data.estado.modoSala === "MANUAL");
                    updateLedUI('2', data.estado.laboratorio === "ON", data.estado.modoLab === "MANUAL");
                }
            });
        }

        function updateLedUI(id, isOn, isManual) {
            const icon = document.getElementById('icon_led' + id);
            const modeTxt = document.getElementById('mode_txt_led' + id);
            const btnOn = document.getElementById('btn_on_' + id);
            const btnOff = document.getElementById('btn_off_' + id);

            // Color del icono
            if(isOn) { icon.classList.add('text-neon-green'); icon.classList.remove('text-slate-500'); }
            else { icon.classList.remove('text-neon-green'); icon.classList.add('text-slate-500'); }

            // Texto de modo
            if(isManual) { modeTxt.innerText = "MANUAL (FORZADO)"; modeTxt.className = "text-[10px] text-neon-orange font-bold font-mono"; }
            else { modeTxt.innerText = "AUTOMÁTICO"; modeTxt.className = "text-[10px] text-neon-blue font-mono"; }

            // Estado de los botones (Visual)
            if(isManual && isOn) {
                btnOn.classList.add('bg-neon-green', 'text-black'); btnOn.classList.remove('text-slate-300');
                btnOff.classList.remove('bg-slate-500');
            } else {
                btnOn.classList.remove('bg-neon-green', 'text-black'); btnOn.classList.add('text-slate-300');
                if(!isManual) btnOff.classList.add('bg-slate-600'); else btnOff.classList.remove('bg-slate-600');
            }
        }

        // Init
        const k = localStorage.getItem('iot_api_key');
        const u = localStorage.getItem('iot_db_url');
        if(k && u) initFirebase(k, u); else setTimeout(() => document.getElementById('configModal').classList.remove('hidden'), 500);
        document.getElementById('authModal').classList.remove('hidden');

    </script>
</body>
</html>
